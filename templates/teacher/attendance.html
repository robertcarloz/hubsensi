{% extends "layout.html" %}
{% from "macros/form_macros.html" import render_field, render_select %}

{% block title %}Absensi Siswa - {{ super() }}{% endblock %}

{% block sidebar_nav %}
<li class="nav-item">
    <a class="nav-link" href="{{ url_for('teacher.dashboard') }}">
        <i class="bi bi-speedometer2 me-2"></i>
        Dashboard
    </a>
</li>
<li class="nav-item">
    <a class="nav-link active" href="{{ url_for('teacher.attendance') }}">
        <i class="bi bi-clipboard-check me-2"></i>
        Absensi Siswa
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="{{ url_for('teacher.scan') }}">
        <i class="bi bi-qr-code-scan me-2"></i>
        Scan QR
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="{{ url_for('teacher.my_attendance') }}">
        <i class="bi bi-person-check me-2"></i>
        Absensi Saya
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="{{ url_for('auth.profile') }}">
        <i class="bi bi-person-circle me-2"></i>
        Profil
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="{{ url_for('auth.logout') }}">
        <i class="bi bi-box-arrow-right me-2"></i>
        Logout
    </a>
</li>
{% endblock %}

{% block page_title %}Absensi Siswa{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <a href="{{ url_for('teacher.scan') }}" class="btn btn-sm btn-primary">
        <i class="bi bi-qr-code-scan me-1"></i> Scan QR
    </a>
</div>
{% endblock %}

{% block page_content %}
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" action="{{ url_for('teacher.attendance') }}" class="row g-3">
               <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="col-md-3">
                <label for="date" class="form-label">Tanggal</label>
                <input type="date" class="form-control" id="date" name="date" value="{{ selected_date }}">
            </div>
            <div class="col-md-4">
                <label for="classroom_id" class="form-label">Kelas</label>
                <select class="form-select" id="classroom_id" name="classroom_id">
                    <option value="">Semua Kelas</option>
                    {% for classroom in classrooms %}
                    <option value="{{ classroom.id }}" {{ 'selected' if selected_classroom == classroom.id }}>
                        {{ classroom.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-filter me-1"></i> Filter
                    </button>
                    <a href="{{ url_for('teacher.attendance') }}" class="btn btn-outline-secondary ms-1">
                        <i class="bi bi-arrow-clockwise me-1"></i> Reset
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Data Absensi</h5>
        <span class="badge bg-primary">{{ selected_date_display }}</span>
    </div>
    <div class="card-body">
        {% if students %}
        <form method="POST" action="{{ url_for('teacher.attendance') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="date" value="{{ selected_date }}">
            <input type="hidden" name="classroom_id" value="{{ selected_classroom }}">
            
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>NIS</th>
                            <th>Nama Siswa</th>
                            <th>Kelas</th>
                            <th>Status</th>
                            <th>Catatan</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in students %}
                        {% set attendance = attendance_records[student.id] if attendance_records %}
                        <tr>
                            <td>{{ student.nis }}</td>
                            <td>{{ student.full_name }}</td>
                            <td>{{ student.classroom.name if student.classroom else '-' }}</td>
                            <td>
                                <select name="status_{{ student.id }}" class="form-select form-select-sm">
                                    <option value="hadir" {{ 'selected' if attendance and attendance.status.value == 'hadir' }}>Hadir</option>
                                    <option value="izin" {{ 'selected' if attendance and attendance.status.value == 'izin' }}>Izin</option>
                                    <option value="sakit" {{ 'selected' if attendance and attendance.status.value == 'sakit' }}>Sakit</option>
                                    <option value="alpha" {{ 'selected' if attendance and attendance.status.value == 'alpha' or not attendance }}>Alpha</option>
                                </select>
                            </td>
                            <td>
                                <input type="text" name="notes_{{ student.id }}" class="form-control form-control-sm" 
                                       placeholder="Catatan" value="{{ attendance.notes if attendance and attendance.notes }}">
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="mt-3">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle me-1"></i> Simpan Absensi
                </button>
                <button type="reset" class="btn btn-outline-secondary ms-2">
                    <i class="bi bi-arrow-clockwise me-1"></i> Reset
                </button>
            </div>
        </form>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-people text-muted fs-1 d-block mb-3"></i>
            <p class="text-muted">Tidak ada siswa ditemukan</p>
            <a href="{{ url_for('teacher.attendance') }}" class="btn btn-primary">
                <i class="bi bi-arrow-clockwise me-1"></i> Muat Ulang
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set default date to today if not set
        const dateInput = document.getElementById('date');
        if (!dateInput.value) {
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
        }
        
        // Quick date selector
        const quickDateButtons = document.querySelectorAll('.quick-date');
        quickDateButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const days = parseInt(this.getAttribute('data-days'));
                const date = new Date();
                date.setDate(date.getDate() + days);
                dateInput.value = date.toISOString().split('T')[0];
                
                // Submit the form
                this.closest('form').submit();
            });
        });
    });
</script>
{% endblock %}