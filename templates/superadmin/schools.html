{% extends "layout.html" %}

{% block title %}Kelola Sekolah - {{ super() }}{% endblock %}

{% block sidebar_nav %}
<li class="nav-item">
    <a class="nav-link" href="{{ url_for('superadmin.dashboard') }}">
        <i class="bi bi-speedometer2 me-2"></i>
        Dashboard
    </a>
</li>
<li class="nav-item">
    <a class="nav-link active" href="{{ url_for('superadmin.schools') }}">
        <i class="bi bi-building me-2"></i>
        Sekolah
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="{{ url_for('auth.logout') }}">
        <i class="bi bi-box-arrow-right me-2"></i>
        Logout
    </a>
</li>
{% endblock %}

{% block page_title %}Kelola Sekolah{% endblock %}

{% block page_actions %}
<a href="{{ url_for('superadmin.add_school') }}" class="btn btn-primary btn-sm">
    <i class="bi bi-plus-circle me-1"></i> Tambah Sekolah
</a>
{% endblock %}

{% block page_content %}
<div class="card">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0">Daftar Semua Sekolah</h5>
            
            <div class="d-flex">
                <input type="text" class="form-control form-control-sm me-2" placeholder="Cari sekolah..." id="searchInput">
                <select class="form-select form-select-sm" id="statusFilter">
                    <option value="">Semua Status</option>
                    <option value="active">Aktif</option>
                    <option value="inactive">Nonaktif</option>
                </select>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover" id="schoolsTable">
                <thead>
                    <tr>
                        <th>Nama Sekolah</th>
                        <th>Kode</th>
                        <th>Alamat</th>
                        <th>Admin</th>
                        <th>Status</th>
                        <th>Tanggal Dibuat</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for school in schools %}
                    <tr>
                        <td>{{ school.name }}</td>
                        <td><span class="badge bg-secondary">{{ school.code }}</span></td>
                        <td>{{ school.address|truncate(30) if school.address else '-' }}</td>
                        <td>
                            {% set admin = school.users | selectattr('role', 'equalto', UserRole.ADMIN) | list | first %}
                            {% if admin %}
                                <span class="badge bg-info">{{ admin.username }}</span>
                            {% else %}
                                <span class="badge bg-warning">Belum ada admin</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-{{ 'success' if school.is_active else 'secondary' }}">
                                {{ 'Aktif' if school.is_active else 'Nonaktif' }}
                            </span>
                        </td>
                        <td>{{ school.created_at.strftime('%d/%m/%Y') }}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('superadmin.edit_school', school_id=school.id) }}" 
                                   class="btn btn-outline-primary" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <button type="button" class="btn btn-outline-{{ 'danger' if school.is_active else 'success' }}" 
                                        title="{{ 'Nonaktifkan' if school.is_active else 'Aktifkan' }}" 
                                        onclick="toggleSchoolStatus({{ school.id }}, {{ 'true' if not school.is_active else 'false' }})">
                                    <i class="bi bi-{{ 'x-circle' if school.is_active else 'check-circle' }}"></i>
                                </button>

                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="bi bi-building text-muted fs-1 d-block mb-2"></i>
                            <p class="text-muted">Belum ada sekolah terdaftar</p>
                            <a href="{{ url_for('superadmin.add_school') }}" class="btn btn-primary">
                                <i class="bi bi-plus-circle me-1"></i> Tambah Sekolah Pertama
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // School table filtering
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const table = document.getElementById('schoolsTable');
        const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        
        function filterTable() {
            const searchText = searchInput.value.toLowerCase();
            const statusValue = statusFilter.value;
            
            for (let i = 0; i < rows.length; i++) {
                const name = rows[i].cells[0].textContent.toLowerCase();
                const code = rows[i].cells[1].textContent.toLowerCase();
                const status = rows[i].cells[4].textContent.toLowerCase();
                
                const matchesSearch = name.includes(searchText) || code.includes(searchText);
                let matchesStatus = true;
                
                if (statusValue === 'active') {
                    matchesStatus = status.includes('aktif');
                } else if (statusValue === 'inactive') {
                    matchesStatus = status.includes('nonaktif');
                }
                
                rows[i].style.display = (matchesSearch && matchesStatus) ? '' : 'none';
            }
        }
        
        searchInput.addEventListener('keyup', filterTable);
        statusFilter.addEventListener('change', filterTable);
    });

    // Toggle school status
    function toggleSchoolStatus(schoolId, newStatus) {
        if (confirm(newStatus ? 'Aktifkan sekolah ini?' : 'Nonaktifkan sekolah ini?')) {
            fetch(`/superadmin/schools/${schoolId}/toggle-status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({ is_active: newStatus })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Gagal mengubah status sekolah: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat mengubah status sekolah');
            });
        }
    }
</script>
{% endblock %}